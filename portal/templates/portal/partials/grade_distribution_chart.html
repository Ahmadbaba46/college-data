{% if is_admin or is_teacher %}
<div class="rounded-2xl border border-slate-200/60 bg-white/90 p-6 shadow-xl backdrop-blur-xl">
  <div class="mb-4 flex items-center justify-between">
    <div>
      <h3 class="text-lg font-bold text-slate-900">Grade Distribution</h3>
      <p class="text-xs text-slate-500">Approved grades breakdown</p>
    </div>
    <div class="text-right">
      <div class="text-2xl font-bold text-slate-900" id="avgCGPA">-</div>
      <div class="text-xs text-slate-500">Avg CGPA</div>
    </div>
  </div>
  
  <div class="relative h-64">
    <canvas id="gradeDistributionChart"></canvas>
  </div>
  
  <div class="mt-4 grid grid-cols-2 gap-4">
    <div class="rounded-lg bg-emerald-50 p-3 text-center">
      <div class="text-2xl font-bold text-emerald-700" id="passRate">-</div>
      <div class="text-xs text-emerald-600">Pass Rate</div>
    </div>
    <div class="rounded-lg bg-rose-50 p-3 text-center">
      <div class="text-2xl font-bold text-rose-700" id="failRate">-</div>
      <div class="text-xs text-rose-600">Fail Rate</div>
    </div>
  </div>
</div>

<script>
(function() {
  const ctx = document.getElementById('gradeDistributionChart');
  if (!ctx) return;
  
  fetch('{% url "portal:grade_distribution_data" %}')
    .then(res => res.json())
    .then(data => {
      // Update metrics
      document.getElementById('avgCGPA').textContent = data.avg_cgpa || '0.00';
      document.getElementById('passRate').textContent = data.pass_rate || '0%';
      document.getElementById('failRate').textContent = data.fail_rate || '0%';
      
      // Color coding for grades
      const gradeColors = {
        'A': 'rgba(34, 197, 94, 0.8)',    // Green
        'B': 'rgba(59, 130, 246, 0.8)',   // Blue
        'C': 'rgba(251, 146, 60, 0.8)',   // Orange
        'D': 'rgba(234, 179, 8, 0.8)',    // Yellow
        'E': 'rgba(239, 68, 68, 0.8)',    // Red
        'F': 'rgba(127, 29, 29, 0.8)',    // Dark Red
      };
      
      const colors = data.labels.map(label => gradeColors[label] || 'rgba(148, 163, 184, 0.8)');
      const borderColors = colors.map(c => c.replace('0.8', '1'));
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Number of Students',
            data: data.values,
            backgroundColor: colors,
            borderColor: borderColors,
            borderWidth: 2,
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              padding: 12,
              borderColor: 'rgba(148, 163, 184, 0.2)',
              borderWidth: 1,
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#64748b',
                font: { size: 11 },
                stepSize: 1
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)',
                drawBorder: false
              }
            },
            x: {
              ticks: {
                color: '#64748b',
                font: { size: 12, weight: 'bold' }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    })
    .catch(err => console.error('Failed to load grade distribution:', err));
})();
</script>
{% endif %}
