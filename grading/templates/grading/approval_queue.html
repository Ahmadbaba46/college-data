{% extends 'portal/base.html' %}

{% block title %}Grade Approval Queue | Admin{% endblock %}

{% block breadcrumb %}
<svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
</svg>
<span class="text-slate-900 font-medium">Grade Approval Queue</span>
{% endblock %}

{% block body %}
<div class="space-y-8" x-data="{ selectedOffering: null, rejectGradeId: null, rejectionReason: '' }">
  <!-- Page Header -->
  <div class="rounded-2xl border border-slate-200/60 bg-gradient-to-br from-white/90 to-amber-50/50 p-8 shadow-xl backdrop-blur-xl">
    <div class="flex items-start justify-between">
      <div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-amber-700 to-orange-600 bg-clip-text text-transparent">
          Grade Approval Queue
        </h1>
        <p class="mt-2 text-slate-600 font-medium">Review and approve submitted grades</p>
        <div class="mt-3">
          <span class="inline-flex items-center gap-2 rounded-lg bg-white/80 border border-amber-200 px-3 py-1.5 text-sm font-semibold text-amber-700">
            {{ total_pending }} grade(s) pending approval
          </span>
        </div>
      </div>
      <div class="hidden sm:flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-amber-600 to-orange-600 shadow-xl shadow-amber-500/30">
        <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Offerings with Pending Grades -->
  {% if offerings_with_grades %}
  <div class="space-y-6">
    {% for item in offerings_with_grades %}
    <div class="rounded-2xl border border-slate-200/60 bg-white shadow-lg overflow-hidden">
      <!-- Offering Header -->
      <div class="border-b border-slate-200 bg-gradient-to-r from-amber-50 to-orange-50 px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold text-slate-900">{{ item.offering.course.code }} - {{ item.offering.course.title }}</h3>
            <p class="text-sm text-slate-600">{{ item.offering.session.name }} â€¢ {{ item.offering.get_semester_display }}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center gap-2 rounded-lg bg-amber-100 px-3 py-1.5 text-sm font-bold text-amber-700">
              {{ item.count }} pending
            </span>
            <form method="post" action="{% url 'grading:grade_approve' 0 %}" class="inline">
              {% csrf_token %}
              <input type="hidden" name="offering_id" value="{{ item.offering.id }}">
              <button 
                type="submit"
                onclick="return confirm('Approve all {{ item.count }} grades for this offering?')"
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-500/30 transition-all hover:shadow-xl hover:scale-105 active:scale-95"
              >
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Approve All
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Grades Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-slate-700">Student ID</th>
              <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-slate-700">Name</th>
              <th class="px-6 py-3 text-center text-xs font-bold uppercase tracking-wider text-slate-700">CA</th>
              <th class="px-6 py-3 text-center text-xs font-bold uppercase tracking-wider text-slate-700">Exam</th>
              <th class="px-6 py-3 text-center text-xs font-bold uppercase tracking-wider text-slate-700">Total</th>
              <th class="px-6 py-3 text-center text-xs font-bold uppercase tracking-wider text-slate-700">Grade</th>
              <th class="px-6 py-3 text-center text-xs font-bold uppercase tracking-wider text-slate-700">Submitted</th>
              <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-slate-700">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white">
            {% for grade in item.grades %}
            <tr class="transition-colors hover:bg-amber-50/30">
              <td class="whitespace-nowrap px-6 py-4">
                <span class="font-mono text-sm font-bold text-slate-800">{{ grade.enrollment.student.student_id }}</span>
              </td>
              <td class="whitespace-nowrap px-6 py-4">
                <span class="text-sm text-slate-700">{{ grade.enrollment.student.full_name }}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-semibold text-slate-700">{{ grade.ca_score }}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-semibold text-slate-700">{{ grade.exam_score }}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-bold text-slate-800">{{ grade.total_score }}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center rounded-full bg-purple-100 px-2.5 py-1 text-xs font-bold text-purple-700">
                  {{ grade.grade }}
                </span>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-center">
                <span class="text-xs text-slate-500">{{ grade.submitted_at|date:"M d, Y H:i" }}</span>
              </td>
              <td class="whitespace-nowrap px-6 py-4 text-right">
                <div class="flex items-center justify-end gap-2">
                  <!-- Approve -->
                  <form method="post" action="{% url 'grading:grade_approve' grade.id %}" class="inline">
                    {% csrf_token %}
                    <button 
                      type="submit"
                      class="inline-flex items-center gap-1 rounded-lg border border-emerald-300 bg-emerald-50 px-3 py-1.5 text-xs font-semibold text-emerald-700 transition-all hover:bg-emerald-100 active:scale-95"
                    >
                      <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      Approve
                    </button>
                  </form>
                  
                  <!-- Reject -->
                  <button 
                    @click="rejectGradeId = {{ grade.id }}; rejectionReason = ''"
                    class="inline-flex items-center gap-1 rounded-lg border border-red-300 bg-red-50 px-3 py-1.5 text-xs font-semibold text-red-700 transition-all hover:bg-red-100 active:scale-95"
                  >
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Reject
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="rounded-2xl border border-slate-200 bg-slate-50 p-12 text-center">
    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <h3 class="mt-4 text-lg font-semibold text-slate-700">No Pending Grades</h3>
    <p class="mt-2 text-sm text-slate-500">All submitted grades have been reviewed.</p>
  </div>
  {% endif %}

  <!-- Rejection Modal -->
  <div 
    x-show="rejectGradeId !== null" 
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm"
    @click.self="rejectGradeId = null"
  >
    <div class="mx-4 w-full max-w-lg rounded-2xl border border-slate-200 bg-white p-6 shadow-2xl">
      <h3 class="text-lg font-bold text-slate-900 mb-4">Reject Grade</h3>
      
      <form method="post" :action="`{% url 'grading:grade_reject' 0 %}`.replace('/0/', '/' + rejectGradeId + '/')">
        {% csrf_token %}
        
        <div class="mb-4">
          <label class="block text-sm font-bold text-slate-700 mb-2">Rejection Reason *</label>
          <textarea 
            name="rejection_reason"
            x-model="rejectionReason"
            required
            rows="4"
            placeholder="Provide a clear reason for rejection..."
            class="w-full rounded-xl border border-slate-300 px-4 py-3 text-slate-900 shadow-sm transition-all focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-500/20"
          ></textarea>
        </div>
        
        <div class="flex items-center gap-3 justify-end">
          <button 
            type="button"
            @click="rejectGradeId = null"
            class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition-all hover:bg-slate-50 active:scale-95"
          >
            Cancel
          </button>
          <button 
            type="submit"
            class="rounded-xl bg-gradient-to-r from-red-600 to-rose-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-red-500/30 transition-all hover:shadow-xl active:scale-95"
          >
            Reject Grade
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
